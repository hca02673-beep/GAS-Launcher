<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloud Launcher V10</title>
<style>
    /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    body { font-family: "Meiryo", sans-serif; background-color: #ECFFFF; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
    
    /* ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    #sync-indicator { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8em; z-index: 9999; display: none; pointer-events: none; }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    #header-row { background-color: #f0f0f0; border-bottom: 3px solid #7D7DFF; display: flex; align-items: center; padding: 5px 10px 0 10px; gap: 10px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-wrap: wrap; }
    #toolbar { display: flex; gap: 5px; padding-bottom: 5px; align-items: center; overflow-x: auto; }
    button { cursor: pointer; padding: 4px 8px; font-size: 0.85em; font-weight: bold; white-space: nowrap; border: 1px solid #999; border-radius: 3px; background-color: #eee; transition: background-color 0.2s; }
    button:hover { background-color: #ddd; }
    
    /* ã‚¿ãƒ– */
    #tab-container { display: flex; gap: 4px; overflow-x: auto; flex-grow: 1; align-self: flex-end; scrollbar-width: none; }
    #tab-container::-webkit-scrollbar { display: none; }
    .tab { padding: 6px 12px; background-color: #ddd; border: 1px solid #999; border-bottom: none; border-radius: 5px 5px 0 0; cursor: pointer; display: flex; align-items: center; gap: 6px; user-select: none; white-space: nowrap; font-size: 0.9em; opacity: 0.8; transition: background-color 0.2s; max-width: 200px; }
    .tab:hover { background-color: #eee; opacity: 1.0; }
    .tab.active { background-color: #7D7DFF; color: white; font-weight: bold; opacity: 1.0; padding-bottom: 8px; margin-top: -2px; }
    .tab-input { background: transparent; border: none; font-family: inherit; font-size: inherit; font-weight: inherit; color: inherit; width: 100px; min-width: 50px; cursor: pointer; }
    .tab-input:focus { background-color: rgba(255,255,255,0.3); outline: none; cursor: text; color: inherit; }
    .tab-icon { font-size: 0.8em; width: 18px; height: 18px; line-height: 18px; text-align: center; border-radius: 50%; color: #555; background-color: rgba(255,255,255,0.6); flex-shrink: 0; }
    .tab-icon:hover { background-color: white; color: black; }
    .tab-close:hover { background-color: #ff6666; color: white; }

    /* ãƒœãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
    #board { display: grid; gap: 10px; overflow-y: auto; height: 100%; padding: 20px; align-content: start; }
    @media (max-width: 700px) { #board { grid-template-columns: 1fr; } }
    @media (min-width: 701px) and (max-width: 1020px) { #board { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 1021px) and (max-width: 1340px) { #board { grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 1341px) and (max-width: 1660px) { #board { grid-template-columns: repeat(4, 1fr); } }
    @media (min-width: 1661px) and (max-width: 1980px) { #board { grid-template-columns: repeat(5, 1fr); } }
    @media (min-width: 1981px) { #board { grid-template-columns: repeat(6, 1fr); } }

    .mobile-page-header { width: 100%; background-color: #666; color: white; padding: 5px 10px; margin-top: 20px; margin-bottom: 10px; font-weight: bold; border-radius: 4px; font-size: 0.95rem; grid-column: 1 / -1; }
    .column { background-color: #ffffff; border: 2px solid #000; display: flex; flex-direction: column; max-height: 400px; box-shadow: 3px 3px 5px rgba(0,0,0,0.2); min-width: 0; }
    .column-header { background-color: #7D7DFF; color: white; padding: 5px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
    .column-header input { background: transparent; border: none; color: white; font-weight: bold; flex-grow: 1; font-size: 1rem; min-width: 0; }
    .column-header input:focus { background-color: rgba(255,255,255,0.2); outline: none; }
    .header-btn { font-size: 0.8em; cursor: pointer; color: #fff; background-color: rgba(0,0,0,0.2); border-radius: 3px; padding: 2px 6px; user-select: none; }
    .header-btn-add { background-color: #4CAF50; font-weight: bold; }
    .header-btn-close { background-color: transparent; color: #fff; font-size: 1.2em; padding: 0 5px; }
    .header-btn-close:hover { color: #ffcccc; }
    .link-list { padding: 5px; flex-grow: 1; overflow-y: auto; min-height: 50px; position: relative; }
    .link-item { padding: 4px; margin-bottom: 2px; background-color: white; border-bottom: 1px dotted #ccc; display: flex; justify-content: space-between; align-items: center; cursor: grab; position: relative; }
    .link-item.dragging { opacity: 0.5; cursor: grabbing; }
    .link-item.drag-over-top { border-top: 3px solid #4CAF50; padding-top: 1px; }
    .link-item:hover { background-color: #e0e0ff; }
    .link-text { text-decoration: none; color: blue; cursor: pointer; display: block; flex-grow: 1; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 5px; pointer-events: auto; }
    .link-text:hover { text-decoration: underline; }
    .controls { display: flex; gap: 4px; flex-shrink: 0; }
    .btn-icon { font-size: 1.1em; cursor: pointer; user-select: none; padding: 0 3px; }
    .link-list.drag-over-bottom { border-bottom: 3px solid #4CAF50; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€šè¨­å®š */
    .modal-overlay { display: none; position: fixed; top:0; left:0; right:0; bottom:0; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 9998; }
    .modal-box { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); width: 90%; max-width: 500px; display: flex; flex-direction: column; }
    .modal-box h3 { margin: 0 0 15px; font-size: 1.2em; }
    .modal-box label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
    .modal-box input, .modal-box textarea { width: 100%; box-sizing: border-box; padding: 6px; border: 1px solid #ccc; border-radius: 3px; font-family: inherit; font-size: 0.95em; }
    .modal-box textarea { resize: vertical; min-height: 80px; }
    .modal-buttons { display: flex; gap: 10px; margin-top: 20px; flex-shrink: 0;}
    .modal-buttons button { flex: 1; padding: 8px; font-size: 1em; }
    
    /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒªã‚¹ãƒˆç”¨ */
    #file-list-container { flex-grow: 1; overflow-y: auto; border: 1px solid #ccc; margin-top: 10px; padding: 5px; max-height: 300px; }
    .file-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .file-item:hover { background-color: #f0f8ff; }
    .file-name { font-weight: bold; font-size: 0.95em; }
    .file-date { color: #666; font-size: 0.85em; }

    @media (max-width: 768px) {
        #toolbar { max-width: 100%; scrollbar-width: thin; }
        .column { max-height: none; }
        #board { padding: 10px; }
    }
</style>
</head>
<body>

<div id="sync-indicator">ğŸ”„ å‡¦ç†ä¸­...</div>

<div id="header-row">
    <div id="toolbar">
        <button id="btnSave" onclick="saveToCloud()" style="background-color:#ffe;" title="ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜">â˜ å†…å®¹ä¿å­˜</button>
        <button id="btnLoad" onclick="loadFromCloud()" style="background-color:#e6f3ff;" title="ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­å‡º">â˜ å†…å®¹èª­å‡º</button>
        <button id="btnBackup" onclick="backupToDrive()" title="ãƒ‰ãƒ©ã‚¤ãƒ–ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ">â˜ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
        <button id="btnRestore" onclick="openFileLoadModal()" title="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ">â˜ğŸ“– ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­å‡º</button>
        <div style="width:1px; height:20px; background:#ccc; margin:0 5px;"></div>
        <button id="btnAddPage" onclick="addNewPage()">â•ãƒšãƒ¼ã‚¸</button>
        <button id="btnAddCategory" onclick="addCategory()">â•ã‚«ãƒ†ã‚´ãƒª</button>
    </div>
    <div id="tab-container"></div>
</div>

<div id="board"></div>

<div id="edit-modal-overlay" class="modal-overlay" onclick="if(event.target === this) closeEditModal();">
    <div id="edit-modal-box" class="modal-box" onclick="event.stopPropagation();">
        <h3 id="modal-title">ç·¨é›†</h3>
        <label for="edit-name-input">åç§°</label>
        <input type="text" id="edit-name-input" placeholder="åç§°ã‚’å…¥åŠ›">
        <div id="link-details-container" style="display:none; flex-direction:column;">
            <label for="edit-url-input">URL</label>
            <input type="text" id="edit-url-input" placeholder="https://...">
            <label for="edit-memo-input">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="edit-memo-input" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›"></textarea>
        </div>
        <div class="modal-buttons">
            <button onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onclick="saveEditModal()" style="background-color:#4CAF50; color:white;">ä¿å­˜</button>
        </div>
    </div>
</div>

<div id="file-select-modal-overlay" class="modal-overlay" onclick="if(event.target === this) closeFileSelectModal();">
    <div id="file-select-modal-box" class="modal-box" onclick="event.stopPropagation();">
        <h3>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­å‡º</h3>
        <div style="font-size:0.85em; color:#666;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ã€ç¾åœ¨ã®ç”»é¢ã¨ãƒ¡ã‚¤ãƒ³DBãŒãã®å†…å®¹ã§ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚</div>
        <div id="file-list-container">
            <div style="padding:10px; text-align:center;">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
        <div class="modal-buttons">
            <button onclick="closeFileSelectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<script>
    // â– â– â–  æ–°ã—ãç™ºè¡Œã•ã‚ŒãŸGASã®URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â– â– â– 
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbygATCYKgzWwyLQbStKmkmNQF_CQR1fon79AU2TxNQeOOmbvndpGsS9xEqD48LZs8OPHA/exec";
    
    const LOCAL_STORAGE_KEY = "launcher_data_v10";
    let pages = [];
    let activePageIndex = 0;
    let editingTarget = null;
    let isDragging = false;
    let isDropProcessing = false;

    // --- åˆæœŸåŒ– ---
    window.onload = function() {
        const localData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (localData) {
            try { pages = JSON.parse(localData); } catch (e) { initDefault(); }
        } else {
            initDefault();
        }
        renderTabs();
        renderBoard();
        checkMobileDisplay();
        // èµ·å‹•æ™‚ã® syncWithCloud() (è‡ªå‹•åŒæœŸ) ã‚’å»ƒæ­¢ã—ã¾ã—ãŸã€‚
    };

    function initDefault() {
        pages = [{ id: "page1", name: "ãƒ¡ã‚¤ãƒ³", categories: [{ title: "ã‚ˆãä½¿ã†ãƒªãƒ³ã‚¯", links: [{ name: "Google", url: "https://www.google.com", memo: "" }] }] }];
    }

    // --- APIé€šä¿¡é–¢é€£ ---
    
    // ã‚¯ãƒ©ã‚¦ãƒ‰(launcer_cloud_db.json)ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å‡ºã™
    function loadFromCloud() {
        if(!confirm("ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å‡ºã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ç”»é¢å†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚")) return;

        const btn = document.getElementById('btnLoad');
        const originalText = btn.innerText;
        btn.innerText = "â³ èª­å‡ºä¸­..."; btn.disabled = true;

        const indicator = document.getElementById('sync-indicator');
        indicator.innerText = "ğŸ”„ èª­è¾¼ä¸­...";
        indicator.style.display = 'block';

        fetch(GAS_API_URL)
            .then(response => response.json())
            .then(data => {
                indicator.style.display = 'none';
                if (data.error) { alert("èª­å‡ºã‚¨ãƒ©ãƒ¼: " + data.error); return; }
                
                if (Array.isArray(data) && data.length > 0) {
                    pages = data;
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pages));
                    renderTabs();
                    renderBoard();
                    btn.innerText = "âœ” å®Œäº†";
                } else {
                    alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã‹ã€å½¢å¼ãŒä¸æ­£ã§ã™ã€‚");
                }
            })
            .catch(err => {
                indicator.style.display = 'none';
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err);
            })
            .finally(() => {
                setTimeout(() => { btn.innerText = originalText; btn.disabled = false; }, 1500);
            });
    }

    // ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜
    function saveToCloud() {
        const btn = document.getElementById('btnSave');
        const originalText = btn.innerText;
        btn.innerText = "â³ ä¿å­˜ä¸­..."; btn.disabled = true;

        // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
        const jsonStr = JSON.stringify(pages);
        localStorage.setItem(LOCAL_STORAGE_KEY, jsonStr);

        postToGas({ action: "save", data: pages })
            .then(res => {
                if (res.status === "SUCCESS") {
                    btn.innerText = "âœ” ä¿å­˜å®Œäº†";
                    btn.style.backgroundColor = "#b3ffb3";
                } else {
                    alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + res.message);
                }
            })
            .catch(err => alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err))
            .finally(() => {
                setTimeout(() => { btn.innerText = originalText; btn.style.backgroundColor = "#ffe"; btn.disabled = false; }, 1500);
            });
    }

    function backupToDrive() {
        if(!confirm("ãƒ‰ãƒ©ã‚¤ãƒ–ã®LauncherBackupsãƒ•ã‚©ãƒ«ãƒ€ã«\nç¾åœ¨ã®ç”»é¢çŠ¶æ…‹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ")) return;
        
        const btn = document.getElementById('btnBackup');
        const originalText = btn.innerText;
        btn.innerText = "â³ ä½œæˆä¸­..."; btn.disabled = true;

        postToGas({ action: "backup", data: pages })
            .then(res => {
                if (res.status === "SUCCESS") {
                    alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ:\n" + res.message);
                    btn.innerText = "âœ” å®Œäº†";
                } else {
                    alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—: " + res.message);
                }
            })
            .catch(err => alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err))
            .finally(() => {
                setTimeout(() => { btn.innerText = originalText; btn.disabled = false; }, 2000);
            });
    }

    function openFileLoadModal() {
        document.getElementById('file-select-modal-overlay').style.display = 'flex';
        const container = document.getElementById('file-list-container');
        container.innerHTML = '<div style="padding:10px; text-align:center;">ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—ä¸­...</div>';

        fetch(GAS_API_URL + "?action=list")
            .then(res => res.json())
            .then(list => {
                container.innerHTML = '';
                if (!Array.isArray(list) || list.length === 0) {
                    container.innerHTML = '<div style="padding:10px; text-align:center;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                    return;
                }
                list.forEach(file => {
                    const d = new Date(file.date);
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.innerHTML = `<span class="file-name">${file.name}</span><span class="file-date">${d.toLocaleString()}</span>`;
                    div.onclick = () => loadSelectedFile(file.id, file.name);
                    container.appendChild(div);
                });
            })
            .catch(err => {
                container.innerHTML = '<div style="padding:10px; color:red;">ã‚¨ãƒ©ãƒ¼: ' + err + '</div>';
            });
    }

    function loadSelectedFile(fileId, fileName) {
        if (!confirm("ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ" + fileName + "ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\n\nâ€»ç¾åœ¨ã®ç”»é¢å†…å®¹ã¯ç ´æ£„ã•ã‚Œã€ãƒ¡ã‚¤ãƒ³DBã‚‚ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚")) return;
        
        closeFileSelectModal();
        const indicator = document.getElementById('sync-indicator');
        indicator.innerText = "â³ å¾©å…ƒãƒ»ä¿å­˜ä¸­...";
        indicator.style.display = 'block';

        postToGas({ action: "restore", fileId: fileId })
            .then(res => {
                indicator.style.display = 'none';
                if (res.status === "SUCCESS") {
                    pages = res.data;
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pages));
                    renderTabs();
                    renderBoard();
                    alert("å¾©å…ƒã¨ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
                } else {
                    alert("å¾©å…ƒã‚¨ãƒ©ãƒ¼: " + res.message);
                }
            })
            .catch(err => {
                indicator.style.display = 'none';
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err);
            });
    }

    function postToGas(payload) {
        return fetch(GAS_API_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify(payload)
        }).then(res => res.json());
    }

    function closeFileSelectModal() { document.getElementById('file-select-modal-overlay').style.display = 'none'; }

    // --- UIãƒ­ã‚¸ãƒƒã‚¯ ---
    function isMobileMode() { return window.innerWidth <= 768; }
    function checkMobileDisplay() {
        const isMobile = isMobileMode();
        document.getElementById('btnAddPage').style.display = isMobile ? 'none' : 'inline-block';
        document.getElementById('btnAddCategory').style.display = isMobile ? 'none' : 'inline-block';
        document.getElementById('tab-container').style.display = isMobile ? 'none' : 'flex';
    }
    window.addEventListener('resize', checkMobileDisplay);

    function switchTab(index) { activePageIndex = index; renderTabs(); renderBoard(); }

    function renderTabs() {
        const isMobile = isMobileMode();
        const container = document.getElementById('tab-container');
        container.innerHTML = '';
        if (isMobile) return;
        pages.forEach((page, index) => {
            const tab = document.createElement('div');
            tab.className = 'tab' + (index === activePageIndex ? ' active' : '');
            
            const input = document.createElement('input');
            input.type = 'text'; input.className = 'tab-input'; input.value = page.name;
            input.onclick = (e) => { e.stopPropagation(); if (index !== activePageIndex) switchTab(index); };
            input.onblur = (e) => { pages[index].name = e.target.value || "ç„¡é¡Œ"; /* ä¿å­˜ã¯æ‰‹å‹•ãƒœã‚¿ãƒ³ã«ä»»ã›ã‚‹ãŸã‚ã“ã“ã§ã¯localStorageã®ã¿ */ localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pages)); };
            input.onkeydown = (e) => { if(e.key === 'Enter') e.target.blur(); };

            const closeIcon = document.createElement('span'); closeIcon.className = 'tab-icon tab-close'; closeIcon.innerHTML = 'Ã—';
            closeIcon.onclick = (e) => { e.stopPropagation(); deletePage(index); };

            tab.onclick = () => switchTab(index);
            tab.append(input, closeIcon);
            container.appendChild(tab);
        });
    }

    function renderBoard() {
        const board = document.getElementById('board');
        board.innerHTML = '';
        const isMobile = isMobileMode();
        const pagesToShow = isMobile ? pages : [pages[activePageIndex]];

        pagesToShow.forEach((page, pageIdx) => {
            const actualPageIdx = isMobile ? pageIdx : activePageIndex;
            if (isMobile && pages.length > 1) {
                const h = document.createElement('div'); h.className = 'mobile-page-header'; h.textContent = page.name; board.appendChild(h);
            }
            page.categories.forEach((cat, catIndex) => {
                const colDiv = document.createElement('div'); colDiv.className = 'column';
                colDiv.ondrop = (e) => { e.preventDefault(); handleLinkDrop(e, actualPageIdx, catIndex); };
                colDiv.ondragover = (e) => e.preventDefault();

                const hDiv = document.createElement('div'); hDiv.className = 'column-header';
                
                const titleInput = document.createElement('input'); titleInput.type = 'text'; titleInput.value = cat.title;
                titleInput.onblur = (e) => { page.categories[catIndex].title = e.target.value; localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pages)); };
                
                const addBtn = document.createElement('span'); addBtn.className = 'header-btn header-btn-add'; addBtn.innerHTML = '+'; addBtn.onclick = () => addLink(actualPageIdx, catIndex);
                const delBtn = document.createElement('span'); delBtn.className = 'header-btn-close'; delBtn.innerHTML = 'Ã—'; delBtn.onclick = () => deleteCategory(actualPageIdx, catIndex);
                
                hDiv.append(titleInput, addBtn, delBtn); colDiv.appendChild(hDiv);

                const listDiv = document.createElement('div'); listDiv.className = 'link-list';
                
                if (cat.links) {
                    cat.links.forEach((link, linkIndex) => {
                        const lDiv = document.createElement('div'); lDiv.className = 'link-item'; lDiv.draggable = true; lDiv.dataset.index = linkIndex;
                        lDiv.ondragstart = (e) => { isDragging = true; lDiv.classList.add('dragging'); e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'internal', pageIdx: actualPageIdx, catIdx: catIndex, linkIdx: linkIndex })); };
                        lDiv.ondragend = () => { isDragging = false; lDiv.classList.remove('dragging'); };
                        lDiv.ondragover = (e) => { e.preventDefault(); };
                        lDiv.ondrop = (e) => { e.stopPropagation(); e.preventDefault(); handleLinkDrop(e, actualPageIdx, catIndex, linkIndex); };

                        const a = document.createElement('a'); a.className = 'link-text'; a.href = link.url; a.innerText = 'ãƒ»' + link.name; a.target = "_blank";
                        a.onclick = (e) => { if (isDragging) { e.preventDefault(); return false; } };

                        const ctrls = document.createElement('div'); ctrls.className = 'controls';
                        const edit = document.createElement('span'); edit.className = 'btn-icon'; edit.innerText = 'âœ'; edit.style.color = 'green'; edit.onclick = (e) => { e.preventDefault(); e.stopPropagation(); openLinkEditModal(actualPageIdx, catIndex, linkIndex); };
                        const del = document.createElement('span'); del.className = 'btn-icon'; del.innerText = 'Ã—'; del.style.color = 'red'; del.onclick = (e) => { e.preventDefault(); e.stopPropagation(); deleteLink(actualPageIdx, catIndex, linkIndex); };
                        
                        ctrls.append(edit, del); lDiv.append(a, ctrls); listDiv.appendChild(lDiv);
                    });
                }
                colDiv.appendChild(listDiv); board.appendChild(colDiv);
            });
        });
    }

    function addLink(pIdx, cIdx) {
        const newLink = { name: "æ–°è¦ãƒªãƒ³ã‚¯", url: "https://", memo: "" };
        if (!pages[pIdx].categories[cIdx].links) pages[pIdx].categories[cIdx].links = [];
        pages[pIdx].categories[cIdx].links.push(newLink);
        renderBoard();
        openLinkEditModal(pIdx, cIdx, pages[pIdx].categories[cIdx].links.length - 1);
    }

    function handleLinkDrop(e, pIdx, cIdx, insertIdx = null) {
        if (isDropProcessing) return; isDropProcessing = true;
        const raw = e.dataTransfer.getData('text/plain');
        try {
            if (raw.startsWith('http')) {
                const newLink = { name: "New Link", url: raw, memo: "" };
                const links = pages[pIdx].categories[cIdx].links || [];
                if (insertIdx !== null && insertIdx !== -1) links.splice(insertIdx, 0, newLink); else links.push(newLink);
                pages[pIdx].categories[cIdx].links = links;
            } else {
                const d = JSON.parse(raw);
                if (d.type === 'internal') {
                   const item = pages[d.pageIdx].categories[d.catIdx].links.splice(d.linkIdx, 1)[0];
                   const dest = pages[pIdx].categories[cIdx].links || [];
                   if (insertIdx !== null && insertIdx !== -1) dest.splice(insertIdx, 0, item); else dest.push(item);
                   pages[pIdx].categories[cIdx].links = dest;
                }
            }
            renderBoard(); localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pages));
        } catch(err){}
        setTimeout(() => isDropProcessing = false, 100);
    }

    function openLinkEditModal(p, c, l) { editingTarget = {p,c,l}; const t = pages[p].categories[c].links[l]; document.getElementById('edit-name-input').value = t.name; document.getElementById('edit-url-input').value = t.url; document.getElementById('edit-memo-input').value = t.memo || ""; document.getElementById('link-details-container').style.display='flex'; document.getElementById('edit-modal-overlay').style.display='flex'; }
    function closeEditModal() { document.getElementById('edit-modal-overlay').style.display='none'; }
    function saveEditModal() { const {p,c,l} = editingTarget; const t = pages[p].categories[c].links[l]; t.name = document.getElementById('edit-name-input').value; t.url = document.getElementById('edit-url-input').value; t.memo = document.getElementById('edit-memo-input').value; renderBoard(); localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pages)); closeEditModal(); }
    
    function addNewPage() { const n = prompt("ãƒšãƒ¼ã‚¸å"); if(n) { pages.push({id:Date.now().toString(), name:n, categories:[]}); renderTabs(); renderBoard(); localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pages)); } }
    function deletePage(i) { if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { pages.splice(i,1); renderTabs(); renderBoard(); localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pages)); } }
    function addCategory() { const n = prompt("ã‚«ãƒ†ã‚´ãƒªå"); if(n) { pages[activePageIndex].categories.push({title:n, links:[]}); renderBoard(); localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pages)); } }
    function deleteCategory(p,i) { if(confirm("å‰Šé™¤ï¼Ÿ")) { pages[p].categories.splice(i,1); renderBoard(); localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pages)); } }
    function deleteLink(p,c,l) { if(confirm("å‰Šé™¤ï¼Ÿ")) { pages[p].categories[c].links.splice(l,1); renderBoard(); localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(pages)); } }
</script>
</body>
</html>
